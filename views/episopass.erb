<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <link rel="stylesheet" href="/stylesheets/episopass.css" type="text/css">
    <script language="JavaScript" src='/javascripts/jquery.js'></script>
    <script language="JavaScript" src='/javascripts/md5.js'></script>
    <script language="JavaScript" src='/javascripts/crypt.js'></script>
<style type="text/css">
<!--
-->
</style>

  <title><%= @name %></title>
  </head>

  <body>
  <h1>EpisoPass - <%= @name %></h1>

  <table>
    <tr><td>Seed: <input type="text" id="seed" value="<%= @seed %>" width=100></td></tr>
    <tr><td>Pass: <input type="text" id="pass" width=100></td></tr>
  </table>
  <p>

  <div id="main">
  </div>

  <input type="button" value="save" id="save">

<script>
var name = '<%= @name %>';
var data = JSON.parse(<%= @json %>);
var qas = data['qas'];
var seed = data['seed'];

var answer = [];
for(i=0;i<qas.length;i++){
  answer[i] = 0;
}

var answerelements = [];

$('#seed').keyup(function(e){
  if(e.keyCode == 13){
    calcpass();
  }
});

$('#pass').keyup(function(e){
  if(e.keyCode == 13){
    calcseed();
  }
});

function aline(i,j){
  var adiv = $('<div>');
  adiv.css('border','none');
  adiv.css('borderWidth','0');
  adiv.css('padding','0');
  adiv.css('margin',0);
  adiv.attr('id','adiv'+i+'_'+j);
  var input = $('<input>');
  if(! answerelements[i]) answerelements[i] = [];
  answerelements[i][j] = input;
  input.attr('type','text');
  input.attr('autocomplete','off');
  input.attr('size','80');
  input.attr('id','input'+i+'_'+j);
  input.attr('qnumber',i);
  input.attr('anumber',j);
  input.val(answers[j]);
  input.css('border','solid');
  input.css('border-width','1px');
  input.css('padding','1');
  input.css('margin','0 0 2 2');
  input.css('vertical-aign','middle');
  input.css('background-color','#ffffff');
  if(j == 0) input.css('background-color','#ccf');
  input.css('font-size','9pt');
  input.css('font-family','sans-serif');
  input.on('click',function(){
    //alert($(this).attr('qnumber'));
    //alert($(this).attr('anumber'));
    //var id = $(this).attr('id');
    //var m = id.match(/input(\d+)_(\d+)/);
    //var q = Number(m[1]);
    //var a = Number(m[2]);
    var q = Number($(this).attr('qnumber'));
    var a = Number($(this).attr('anumber'));
    answer[q] = a;
    for(var i=0;i<qas[q]['answers'].length;i++){
      //var e = $('#input'+String(q)+'_'+String(i));
      var e = answerelements[q][i];
      if(i == a){
        e.css('background-color','#ccf');
      }
      else {
        e.css('background-color','#fff');
      }
    }
    calcpass();
  });
  input.on('blur',function(){ // フォーカスがはずれたとき
    // $(this).css('background','#fff');
  });
  input.on('keyup',function(){
    var id = $(this).attr('id');
    var m = id.match(/input(\d+)_(\d+)/);
    var q = Number(m[1]);
    var a = Number(m[2]);
    answers = qas[q]['answers'];
    answers[a] = $(this).val();
    //alert(qas[q]['answers']);
    calcpass();
  });
  adiv.append(input);
  return adiv;
}

for(i=0;i<qas.length;i++){
  var question = qas[i]['question'];
  var answers = qas[i]['answers'];

  var div = $("<div>");
  div.css('background-color','#cee');
  div.css('padding','2');
  div.css('width','100%');

  var qdiv = $('<div>');
  qdiv.attr('width','100%');
  qdiv.css('width','100%');
  qdiv.css('border','none');
  qdiv.css('border-width','0');
  qdiv.css('padding','0');
  qdiv.css('margin',0);

  var qinput = $('<input>');
  qinput.attr('type','text');
  qinput.attr('autocomplete','off');
  qinput.css('width','100%');

  qinput.attr('id','question' + String(i));
  qinput.val(question);
  qinput.css('background-color','white');
  qinput.css('font-size','10pt');
  qinput.css('font-family','sans-serif');
  qinput.css('border','solid');
  qinput.css('border-width','1px');
  qinput.css('padding','2');
  qinput.css('margin','0 0 2 2');
  qinput.css('vertical-aign','middle');
  qinput.on('keyup',function(){
    var id = $(this).attr('id');
    var m = id.match(/question(\d+)/);
    var q = Number(m[1]);
    qas[q]['question'] = $(this).val();
    calcpass();
  });

  qdiv.append(qinput);
  div.append(qdiv);

  var img = $("<img>");
  img.attr('id',"image" + String(i));
  img.css('float','left');
  img.css('height','100');
  img.css('padding','2');

  img.attr('src',"http://farm1.static.flickr.com/54/121077554_eb0138d019.jpg");
  //http://gyazo.com/91046da67ab2e43cc4e6456e93c09cd1.png
  div.append(img);

  var ansdiv = $("<div>");
  ansdiv.attr('id','ansdiv' + String(i));
  ansdiv.css('float','left');
  ansdiv.css('padding','0');
  for(var j=0;j<answers.length;j++){
    ansdiv.append(aline(i,j));
  }

  var plus = $('<span>');
  plus.text('＋');
  plus.attr('id','aplus' + String(i));
  plus.css('background-color','#ffffff');
  plus.css('margin','2');
  plus.css('padding','1');
  plus.css('border-width','2');
  plus.css('border-style','outset');
  plus.css('border-color','black');
  plus.css('text-decoration','none');
  plus.css('text-color','black');
  plus.css('vertical-align','middle');
  plus.css('width','20');
  plus.css('text-align','center');
  plus.css('float','left');
  plus.click(function(event){
    alert(event);
  });
//    var m = eventid(event).match(/aplus(.*)$/);
//    var n = Number(m[1]);
//    data[n].push('新しい回答例');
//    var e = document.getElementById('ansdiv'+n);
//    var minus = e.lastChild;
//    e.removeChild(minus);
//    var plus = e.lastChild;
//    e.removeChild(plus);
//    e.appendChild(answerspan(n,data[n].length-1-1));
//    e.appendChild(plus);
//    e.appendChild(minus);
//    display();
//    greasemonkey();
//  }
  ansdiv.append(plus);

  div.append(ansdiv);


  var br = $('<br>');
  br.attr('clear','all');
  div.append(br);

  $("#main").append(div);
}

function secretstr(){
  var secret = "";
  for(var i=0;i<qas.length;i++){
    secret += qas[i]['question'];
    secret += qas[i]['answers'][answer[i]];
  }
  return secret;
}

function calcpass(){
  $('#pass').val(crypt($('#seed').val(),secretstr()));
  // alert(JSON.stringify(data));
}

function calcseed(){
  $('#seed').val(crypt($('#pass').val(),secretstr()));
}


$("#save").click(function(){
  //alert(JSON.stringify(data));
  $.ajax({
    type: "POST",
    async: true,
    url: "/" + name + "/__write",
    data: "data=" + JSON.stringify(data)
  });
});

calcpass();

</script>

  </body>
</html>
